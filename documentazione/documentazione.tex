\documentclass[]{report}

\usepackage[italian]{babel}

\input{settings/packages.tex}
\input{settings/titles_settings.tex}
\input{settings/page_style.tex}
\input{settings/commands.tex}

\linespread{1.2} % imposta lo spazio tra le righe
\fontdimen2\font=0.5em % imposta spazio tra le parole

\title{\textbf{Progetto LSO}\\Libreria}
\author{
    Ingenito Roberto - N86004077\\
    Ingenito Simone - N86004063\\
    Sequino Lorenzo - N86004367 
   }
\date{}


\begin{document}

\maketitle

\newpage

\tableofcontents

\newpage

\input{settings/table_of_contents.tex}

\newpage
\chapter{Analisi dei requisiti}
\section{Obiettivo del progetto}
\section{Funzionalità principali}
\subsection{Registrazione e login utenti}
\subsection{Gestione del catalogo dei libri}
\subsection{Prestito di libri}
\subsection{Gestione del carrello e check-out}
\subsection{Notifiche agli utenti}

\chapter{Implementazione}
\begin{sequencediagram}
	\newthread{u}{User}
	\newinst[2.9]{c}{Client}
	\newinst[2.9]{s}{Server}
	\newinst[2.9]{d}{Database}

	\begin{messcall}{u}{\footnotesize Inserisce dati (se richiesto)}{c}
		\begin{call}{c}{\texttt{funzione()}}{s}{risultato}
			\begin{call}{s}{\texttt{handler()}}{s}{}
				\begin{call}{s}{\texttt{funzione()}}{d}{}
					\begin{callself}{d}{Esegue query}{}
					\end{callself}
				\end{call}
			\end{call}
		\end{call}
	\end{messcall}
\end{sequencediagram}\bskip
Questo \textit{sequence diagram} descrive la maggior parte delle funzionalità presenti nel progetto.\\
Viene fornito giusto un esempio per la registrazione nel paragrafo apposito.

\section{Linguaggi utilizzati}
Il progetto utilizza due linguaggi principali:
\begin{itemize}
	\item \textbf{C}: Il linguaggio C è utilizzato per lo sviluppo dell'applicazione client-server. Il server e il client comunicano tramite socket, permettendo lo scambio di dati in rete.
	\item \textbf{SQL}: Il linguaggio SQL è utilizzato per la gestione del database PostgreSQL. Il server si connette al database per eseguire operazioni di lettura e scrittura, gestendo le informazioni richieste dai client.
\end{itemize}

\newpage
\section{Struttura del codice}
Il progetto è organizzato in una struttura di cartelle che separa logicamente i vari componenti del progetto.\\
Questa organizzazione aiuta a mantenere il codice pulito, modulare e facile da gestire.\meskip
Di seguito, è riportata la struttura gerarchica delle cartelle:
\begin{verbatim}
    project_root
    +-- client
    |   +-- build
    |   +-- include
    |   +-- src
    +-- config
    +-- database
    |   +-- include
    |   +-- query
    |   +-- src
    +-- server
        +-- build
        +-- include
        +-- src
\end{verbatim}

\subsubsection*{\underline{client / server}}
Le cartelle \texttt{client} e \texttt{server} hanno la stessa struttura:
\begin{itemize}
	\item \texttt{\textbf{build}}: Contiene i file oggetto generati dalla compilazione del codice contenuto in \texttt{src}
	\item \texttt{\textbf{include}}: Contiene i file header
	\item \texttt{\textbf{src}}: Contiene il codice sorgente
\end{itemize}
La separazione tra \texttt{include} e \texttt{src} permette una chiara distinzione tra le interfacce e le implementazioni, migliorando la manutenibilità del codice. \\
La cartella build isola i file generati dalla compilazione, mantenendo pulito il repository.

\subsubsection*{\underline{config}}
Questa cartella possiede dei file di configurazione con implementazioni comuni sia per il \textit{client} che per il \textit{server}.\\
Ad esempio la configurazione del database, le richieste che client e server possono (rispettivamente) fare e ricevere, oppure la configurazione degli indirizzi.\meskip
Centralizzare le configurazioni in una cartella dedicata facilita la gestione delle impostazioni del sistema e permette di modificare facilmente i parametri di configurazione senza dover cercare all'interno del codice sorgente.

\subsubsection*{\underline{database}}
\begin{itemize}
	\item \texttt{\textbf{include}}: Contiene i file header per la gestione del database.
	\item \texttt{\textbf{query}}: Contiene i file SQL utilizzati per la gestione del database. (Creazione delle tabelle, trigger, funzioni, viste, \dots)
	\item \texttt{\textbf{src}}: Contiene il codice sorgente per l'interazione con il database.
\end{itemize}
La separazione dei file SQL e del codice sorgente relativo al database aiuta a mantenere organizzate le operazioni di gestione del database e facilita eventuali modifiche o aggiornamenti.

\newpage

\newpage
\section{Registrazione e login}
\begin{sequencediagram}
	\newthread{u}{User}
	\newinst[2.9]{c}{Client}
	\newinst[2.9]{s}{Server}
	\newinst[2.9]{d}{Database}

	\begin{messcall}{u}{Inserisce credenziali}{c}
		\begin{call}{c}{\texttt{sign\_up()}}{s}{risultato registrazione}
			\begin{call}{s}{\texttt{handle\_signup()}}{s}{}
				\begin{call}{s}{\texttt{sign\_up()}}{d}{}
					\begin{callself}{d}{Esegue query}{}
					\end{callself}
				\end{call}
			\end{call}
		\end{call}
	\end{messcall}
\end{sequencediagram}\bskip
L'utente inserisce le credenziali per la registrazione (\textit{sign\_up}) o l'accesso (\textit{sign\_in}). \\
Il client invia tre messaggi al server:
\begin{enumerate}
	\item tipo di richiesta: \texttt{SIGN\_IN} o \texttt{SIGN\_UP}
	\item username
	\item password
\end{enumerate}
Il server elabora la richiesta eseguendo una query con i dati ricevuti e successivamente invia un messaggio al client per notificare l'esito dell'operazione, indicando se la richiesta è stata eseguita con successo o meno.

\section{Gestione dei libri e del catalogo}
Il client può inviare diverse richieste al server per ottenere informazioni sui libri presenti nel sistema. Il server risponde a queste richieste eseguendo specifiche funzioni che interrogano il database.\\
Di seguito, una panoramica delle funzionalità disponibili:
\begin{enumerate}
	\item Visualizzare l'intero catalogo
	\item Visualizzare solo i libri disponibili
	\item Cercare libri per genere
	\item Cercare libri per titolo
\end{enumerate}
Tutte queste funzioni restituiscono i risultati in formato JSON.
Invece di inviare una stringa per volta per poi dover scomporre ogni campo, tramite JSON si facilita l'integrazione lato client.

\section{Prestito e restituzione libri}
Il client può interagire con il server per gestire i prestiti dei libri. Il server offre diverse funzionalità per supportare queste operazioni:
\begin{enumerate}
	\item Creare un nuovo prestito
	\item Visualizzare i libri attualmente in prestito
	\item Restituire un libro
\end{enumerate}

\section{Carrello e check-out}
L'utente può aggiungere libri al carrello, che viene mantenuto localmente sul client stesso. Quando l'utente decide di procedere al checkout, i libri presenti nel carrello vengono inviati al server. Il server poi elabora la richiesta, gestendo il processo di prestito.\meskip
La funzione \texttt{handle\_loan\_requests} gestisce le richieste di prestito di libri da parte del client. Essa svolge le seguenti operazioni principali:
\begin{itemize}
	\item Legge gli ISBN dei libri richiesti dal client e li memorizza in una lista fino a quando non riceve il messaggio "\texttt{STOP}".
	\item Blocca un mutex (semaforo) per garantire l'accesso esclusivo alla sezione critica del codice che gestisce la creazione dei prestiti, poi chiama la funzione \texttt{create\_loans} per processare le richieste di prestito.
	\item Dopo aver elaborato le richieste, invia un codice di stato al client per indicare se la query è riuscita o meno.
	\item Sblocca il mutex al termine dell'operazione.
\end{itemize}\medskip
La richiesta di prestito di un libro è una sezione critica del sistema, poiché coinvolge la modifica dello stato, sul database, dei prestiti. In particolare, se un libro ha solo una copia disponibile e più utenti tentano di richiedere contemporaneamente il prestito di quel libro, il database potrebbe diventare inconsistente. Questo può succedere se entrambi i processi di richiesta vedono la copia come disponibile e procedono con l'assegnazione, portando a una situazione in cui il libro appare come prestato a più utenti contemporaneamente. L'uso di mutex garantisce che solo un processo possa effettuare la richiesta di prestito per quel libro alla volta, assicurando che il database rimanga coerente.

\section{Gestione delle notifiche}
Quando l'utente accede al sistema, il server verifica se ha prestiti scaduti che devono essere restituiti. Se l'utente ha prestiti scaduti, il server invia una notifica al client informandolo della situazione.

\section{Funzioni speciali}
La funzione \texttt{send\_string\_segmented} invia una stringa al client tramite il socket, suddividendo la stringa in segmenti di lunghezza massima definita da \texttt{MAX\_REQUEST\_BUFFER\_LENGTH}.\\
Iterativamente ogni segmento viene inviato al client in maniera ordinata. \meskip
La funzione \texttt{recv\_and\_compose\_segmented\_string}, riceve una stringa di lunghezza \\ massima \texttt{MAX\_REQUEST\_BUFFER\_LENGTH}; esegue questo processo iterativamente, accodando il nuovo segmento al segmento precedente.\\
Al termine, la funzione restituisce l'intera stringa.\bskip
Queste funzioni sono necessarie per gestire l'invio e la ricezione di dati di lunghezza variabile poiché TCP non garantisce che tutti i dati vengano ricevuti in una singola operazione, specialmente se i dati sono di grandi dimensioni.


\chapter{Database}
\section{Schema}
\begin{tikzpicture}
	% User table
	\begin{class}[text width=6cm]{user}{0,-7}
		\attribute{username: TEXT}
		\attribute{passw: TEXT}
	\end{class}

	% Book table
	\begin{class}[text width=7cm]{book}{10,-7}
		\attribute{isbn: TEXT}
		\attribute{title: TEXT}
		\attribute{authors: TEXT[]}
		\attribute{genre: TEXT[]}
		\attribute{quantity: INTEGER}
	\end{class}

	% Loan table
	\begin{class}[text width=8cm]{loan}{5,0}
		\attribute{id: SERIAL}
		\attribute{loan\_start: TIMESTAMP WITH TIME ZONE}
		\attribute{loan\_end: TIMESTAMP WITH TIME ZONE}
		\attribute{returned: TIMESTAMP WITH TIME ZONE}
		\attribute{username: TEXT}
		\attribute{isbn: TEXT}
	\end{class}

	% Relationships
	\association{user}{}{~\qquad0..*}{loan}{1..1\qquad~}{}
	\association{book}{}{0..*\qquad~}{loan}{~\qquad1..1}{}
\end{tikzpicture}

\section{Descrizione delle tabelle}
La tabella \texttt{\underline{user}} è gestisce gli utenti del sistema.\\
Ogni record in questa tabella rappresenta un singolo utente, identificato univocamente dal campo \texttt{username} il quale funge anche da chiave primaria, garantendo cosi anche l'unicità.\bskip
La tabella \texttt{\underline{book}} contiene le informazioni relative ai libri presenti nel catalogo della biblioteca. Ogni libro è identificato dal suo codice \texttt{ISBN}, che funge da chiave primaria. La tabella include campi anche per gli autori e i generi, entrambi memorizzati come array per gestire libri con molteplici autori o appartenenti a più generi. Il campo \texttt{quantity} tiene traccia del numero di copie disponibili per ciascun titolo, con un vincolo che assicura che questo valore non possa essere negativo.\bskip
La tabella \texttt{\underline{loan}} gestisce le informazioni relative ai prestiti dei libri. Ogni prestito è identificato da un \texttt{ID}.\sskip
La tabella registra le date di inizio e fine prevista del prestito, nonché la data effettiva di restituzione (che può essere \texttt{null} per i prestiti in corso).\sskip
I campi \texttt{username} e \texttt{isbn} fungono da chiavi esterne. Questa struttura permette di tracciare efficacemente chi ha preso in prestito quale libro e quando.

\section{Trigger}
Il trigger \texttt{check\_book\_availability} verifica se un libro è disponibile prima di registrare un nuovo prestito. 
Quando viene eseguita, la funzione esamina la quantità di copie disponibili del libro: 
se il libro è disponibile inserisce il prestito; se il libro non è disponibile, viene sollevata un'eccezione, impedendo così l'inserimento del prestito e notificando l'utente che il libro non può essere prestato.\bskip
Il trigger \texttt{set\_loan\_dates} imposta la data di inizio del prestito alla data e ora corrente, e la data di fine a 30 giorni dalla data di inizio





\end{document}




